# æ£€ç´¢å¢å¼ºç”Ÿæˆç»„ä»¶ (RAGs)

æœ¬ç›®å½•åŒ…å«RAGï¼ˆRetrieval-Augmented Generationï¼‰ç›¸å…³ç»„ä»¶ï¼Œæä¾›çŸ¥è¯†åº“æ£€ç´¢å’Œå¢å¼ºç”ŸæˆåŠŸèƒ½ã€‚

## ğŸ“‹ ç»„ä»¶åˆ—è¡¨

### 1. ModelstudioRag - ç™¾ç‚¼RAGç»„ä»¶
æ ¸å¿ƒçš„æ£€ç´¢å¢å¼ºç”ŸæˆæœåŠ¡ï¼Œèƒ½å¤Ÿå¬å›ç”¨æˆ·åœ¨ç™¾ç‚¼å¹³å°ä¸Šçš„çŸ¥è¯†åº“ä¿¡æ¯å¹¶è¿›è¡Œæ™ºèƒ½å›ç­”ã€‚

**å‰ç½®ä½¿ç”¨æ¡ä»¶ï¼š**
- æœ‰æ•ˆçš„DashScope APIå¯†é’¥
- é…ç½®ç™¾ç‚¼HTTPåŸºç¡€URL
- ç”¨æˆ·å·²åœ¨ç™¾ç‚¼å¹³å°åˆ›å»ºçŸ¥è¯†åº“
- çŸ¥è¯†åº“ä¸­æœ‰ç›¸å…³æ–‡æ¡£å†…å®¹

**è¾“å…¥å‚æ•° (RagInput)ï¼š**
- `messages` (List): å¯¹è¯æ¶ˆæ¯åˆ—è¡¨
- `rag_options` (Dict): RAGé€‰é¡¹é…ç½®
  - `knowledge_base_id`: çŸ¥è¯†åº“ID
  - `top_k`: æ£€ç´¢æ¡ç›®æ•°é‡
  - `score_threshold`: ç›¸ä¼¼åº¦é˜ˆå€¼
  - `enable_citation`: æ˜¯å¦å¯ç”¨å¼•ç”¨
- `rest_token` (str): è®¤è¯ä»¤ç‰Œ
- `image_urls` (List[str], å¯é€‰): å›¾ç‰‡URLåˆ—è¡¨ï¼ˆå¤šæ¨¡æ€æ”¯æŒï¼‰
- `workspace_id` (str, å¯é€‰): å·¥ä½œç©ºé—´ID

**è¾“å‡ºå‚æ•° (RagOutput)ï¼š**
- `raw_result` (str): åŸå§‹æ£€ç´¢ç»“æœ
- `rag_result` (Dict): ç»“æ„åŒ–RAGç»“æœ
  - `answer`: ç”Ÿæˆçš„ç­”æ¡ˆ
  - `references`: ç›¸å…³æ–‡æ¡£å¼•ç”¨
  - `confidence`: ç½®ä¿¡åº¦åˆ†æ•°
- `messages` (List): å¤„ç†åçš„æ¶ˆæ¯åˆ—è¡¨

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- **æ™ºèƒ½æ£€ç´¢**: åŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦çš„æ–‡æ¡£æ£€ç´¢
- **ä¸Šä¸‹æ–‡èåˆ**: å°†æ£€ç´¢å†…å®¹ä¸å¯¹è¯ä¸Šä¸‹æ–‡èåˆ
- **ç­”æ¡ˆç”Ÿæˆ**: åŸºäºæ£€ç´¢å†…å®¹ç”Ÿæˆå‡†ç¡®å›ç­”
- **å¼•ç”¨æ”¯æŒ**: æä¾›ç­”æ¡ˆæ¥æºçš„æ–‡æ¡£å¼•ç”¨
- **å¤šæ¨¡æ€æ”¯æŒ**: æ”¯æŒæ–‡æœ¬å’Œå›¾ç‰‡æ··åˆæ£€ç´¢

### 2. ModelstudioRagLite - ç™¾ç‚¼RAGè½»é‡ç‰ˆ
æä¾›è½»é‡åŒ–çš„RAGåŠŸèƒ½ï¼Œé€‚åˆèµ„æºå—é™æˆ–å¿«é€Ÿå“åº”çš„åœºæ™¯ã€‚

**å‰ç½®ä½¿ç”¨æ¡ä»¶ï¼š**
- åŸºæœ¬çš„ç™¾ç‚¼æœåŠ¡é…ç½®
- è¾ƒå°è§„æ¨¡çš„çŸ¥è¯†åº“

**ä¸»è¦ç‰¹ç‚¹ï¼š**
- æ›´å¿«çš„å“åº”é€Ÿåº¦
- è¾ƒä½çš„èµ„æºæ¶ˆè€—
- ç®€åŒ–çš„é…ç½®é€‰é¡¹
- é€‚åˆç§»åŠ¨ç«¯æˆ–è¾¹ç¼˜è®¡ç®—

## ğŸ”§ ç¯å¢ƒå˜é‡é…ç½®

| ç¯å¢ƒå˜é‡ | å¿…éœ€ | é»˜è®¤å€¼ | è¯´æ˜ |
|---------|------|--------|------|
| `DASHSCOPE_API_KEY` | âœ… | - | DashScope APIå¯†é’¥ |
| `DASHSCOPE_HTTP_BASE_URL` | âœ… | - | ç™¾ç‚¼æœåŠ¡HTTPåŸºç¡€URL |
| `DEFAULT_KNOWLEDGE_BASE_ID` | âŒ | - | é»˜è®¤çŸ¥è¯†åº“ID |
| `DEFAULT_TOP_K` | âŒ | 5 | é»˜è®¤æ£€ç´¢æ¡ç›®æ•° |
| `DEFAULT_SCORE_THRESHOLD` | âŒ | 0.7 | é»˜è®¤ç›¸ä¼¼åº¦é˜ˆå€¼ |

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€RAGæŸ¥è¯¢ç¤ºä¾‹

```python
from agentscope_runtime.tools.RAGs.modelstudio_rag import ModelstudioRag
import asyncio

# åˆå§‹åŒ–RAGç»„ä»¶
rag = ModelstudioRag()


async def rag_query_example():
    result = await rag.arun({
        "messages": [
            {"role": "user", "content": "è¯·ä»‹ç»ä¸€ä¸‹äººå·¥æ™ºèƒ½çš„å‘å±•å†å²"}
        ],
        "rag_options": {
            "knowledge_base_id": "kb_12345",
            "top_k": 3,
            "score_threshold": 0.8,
            "enable_citation": True
        },
        "rest_token": "your_auth_token"
    })

    print("RAGå›ç­”:", result.rag_result["answer"])
    print("å‚è€ƒæ–‡çŒ®:", result.rag_result["references"])


asyncio.run(rag_query_example())
```

### å¤šè½®å¯¹è¯RAGç¤ºä¾‹

```python
async def multi_turn_rag_example():
    conversation_history = [
        {"role": "user", "content": "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"},
        {"role": "assistant", "content": "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªé‡è¦åˆ†æ”¯..."},
        {"role": "user", "content": "å®ƒæœ‰å“ªäº›ä¸»è¦ç±»å‹ï¼Ÿ"}
    ]

    result = await rag.arun({
        "messages": conversation_history,
        "rag_options": {
            "knowledge_base_id": "kb_ai_encyclopedia",
            "top_k": 5,
            "enable_citation": True
        },
        "rest_token": "your_auth_token"
    })

    print("åŸºäºä¸Šä¸‹æ–‡çš„å›ç­”:", result.rag_result["answer"])


asyncio.chat(multi_turn_rag_example())
```

### å¤šæ¨¡æ€RAGç¤ºä¾‹

```python
async def multimodal_rag_example():
    result = await rag.arun({
        "messages": [
            {"role": "user", "content": "è¯·åˆ†æè¿™å¼ å›¾ç‰‡ä¸­çš„æŠ€æœ¯æ¶æ„"}
        ],
        "image_urls": [
            "https://example.com/architecture_diagram.png"
        ],
        "rag_options": {
            "knowledge_base_id": "kb_tech_docs",
            "top_k": 3,
            "enable_citation": True
        },
        "rest_token": "your_auth_token"
    })

    print("å¤šæ¨¡æ€åˆ†æç»“æœ:", result.rag_result["answer"])


asyncio.chat(multimodal_rag_example())
```

## ğŸ—ï¸ RAGæ¶æ„ç‰¹ç‚¹

### æ£€ç´¢ç­–ç•¥
- **å¯†é›†æ£€ç´¢**: åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„è¯­ä¹‰æ£€ç´¢
- **ç¨€ç–æ£€ç´¢**: åŸºäºå…³é”®è¯åŒ¹é…çš„ç²¾ç¡®æ£€ç´¢
- **æ··åˆæ£€ç´¢**: ç»“åˆå¯†é›†å’Œç¨€ç–æ£€ç´¢çš„ä¼˜åŠ¿
- **é‡æ’åº**: å¯¹æ£€ç´¢ç»“æœè¿›è¡Œç›¸å…³æ€§é‡æ’åº

### ç”Ÿæˆç­–ç•¥
- **ä¸Šä¸‹æ–‡æ³¨å…¥**: å°†æ£€ç´¢å†…å®¹æ³¨å…¥åˆ°ç”Ÿæˆæ¨¡å‹
- **ç­”æ¡ˆåˆæˆ**: åŸºäºå¤šä¸ªæ–‡æ¡£ç‰‡æ®µåˆæˆç­”æ¡ˆ
- **å¼•ç”¨ç”Ÿæˆ**: è‡ªåŠ¨ç”Ÿæˆç­”æ¡ˆçš„æ–‡æ¡£å¼•ç”¨
- **äº‹å®éªŒè¯**: å¯¹ç”Ÿæˆç­”æ¡ˆè¿›è¡Œäº‹å®æ€§æ£€æŸ¥

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### æ£€ç´¢ä¼˜åŒ–
- ä½¿ç”¨å‘é‡ç´¢å¼•åŠ é€Ÿæ£€ç´¢ï¼ˆå¦‚FAISSã€Milvusï¼‰
- å®ç°æ£€ç´¢ç»“æœç¼“å­˜
- ä¼˜åŒ–æ–‡æ¡£åˆ†å—å’ŒåµŒå…¥ç­–ç•¥
- å¹¶è¡Œå¤„ç†å¤šä¸ªæ£€ç´¢è¯·æ±‚

### ç”Ÿæˆä¼˜åŒ–
- è®¾ç½®åˆç†çš„ä¸Šä¸‹æ–‡é•¿åº¦é™åˆ¶
- ä½¿ç”¨æµå¼ç”Ÿæˆæé«˜ç”¨æˆ·ä½“éªŒ
- å®ç°ç­”æ¡ˆè´¨é‡è¯„åˆ†æœºåˆ¶
- ä¼˜åŒ–æ¨¡å‹æ¨ç†å‚æ•°

## ğŸ“¦ ä¾èµ–åŒ…
- `aiohttp`: å¼‚æ­¥HTTPå®¢æˆ·ç«¯
- `dashscope`: DashScope SDK
- `asyncio`: å¼‚æ­¥ç¼–ç¨‹æ”¯æŒ
- `numpy`: æ•°å€¼è®¡ç®—ï¼ˆå‘é‡æ“ä½œï¼‰
- `faiss`: å‘é‡æ£€ç´¢ï¼ˆå¯é€‰ï¼‰

## âš ï¸ ä½¿ç”¨æ³¨æ„äº‹é¡¹

### çŸ¥è¯†åº“ç®¡ç†
- å®šæœŸæ›´æ–°çŸ¥è¯†åº“å†…å®¹ï¼Œç¡®ä¿ä¿¡æ¯æ—¶æ•ˆæ€§
- åˆç†è®¾è®¡æ–‡æ¡£åˆ†å—ç­–ç•¥ï¼Œå¹³è¡¡æ£€ç´¢ç²¾åº¦å’Œå¬å›ç‡
- ç›‘æ§çŸ¥è¯†åº“çš„æŸ¥è¯¢æ€§èƒ½å’Œå‘½ä¸­ç‡
- å»ºç«‹çŸ¥è¯†åº“ç‰ˆæœ¬ç®¡ç†æœºåˆ¶

### æŸ¥è¯¢ä¼˜åŒ–
- è®¾ç½®åˆé€‚çš„ç›¸ä¼¼åº¦é˜ˆå€¼ï¼Œé¿å…æ£€ç´¢åˆ°ä¸ç›¸å…³å†…å®¹
- åˆç†é…ç½®top_kå‚æ•°ï¼Œå¹³è¡¡ç­”æ¡ˆè´¨é‡å’Œå“åº”é€Ÿåº¦
- å¯¹é•¿æŸ¥è¯¢è¿›è¡Œé¢„å¤„ç†å’Œä¼˜åŒ–
- å®ç°æŸ¥è¯¢æ„å›¾åˆ†æå’Œè·¯ç”±

### ç­”æ¡ˆè´¨é‡æ§åˆ¶
- å»ºç«‹ç­”æ¡ˆè´¨é‡è¯„ä¼°æœºåˆ¶
- å¯¹ç”Ÿæˆç­”æ¡ˆè¿›è¡Œäº‹å®æ€§æ£€æŸ¥
- å¤„ç†æ£€ç´¢ç»“æœä¸è¶³çš„æƒ…å†µ
- æä¾›ç­”æ¡ˆç½®ä¿¡åº¦è¯„åˆ†

## ğŸ”— ç›¸å…³ç»„ä»¶
- å¯ä¸æœç´¢ç»„ä»¶ç»“åˆï¼Œæ‰©å±•çŸ¥è¯†æ¥æº
- æ”¯æŒä¸å†…å­˜ç»„ä»¶é›†æˆï¼Œæä¾›ä¸ªæ€§åŒ–RAGä½“éªŒ
- å¯ä¸æ„å›¾è¯†åˆ«ç»„ä»¶é…åˆï¼Œå®ç°æ™ºèƒ½çŸ¥è¯†é—®ç­”
- æ”¯æŒä¸æ’ä»¶ç³»ç»Ÿé›†æˆï¼Œæ‰©å±•RAGåŠŸèƒ½èŒƒå›´