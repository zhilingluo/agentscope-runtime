load_module /usr/lib/nginx/modules/ndk_http_module.so;
load_module /usr/lib/nginx/modules/ngx_http_lua_module.so;

error_log stderr warn;

worker_processes 1;

env SECRET_TOKEN;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    server {
        listen 80;

        location /fastapi/ {
            proxy_pass http://127.0.0.1:8001/;

            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }


        location = /websockify {
            rewrite ^ /websockify/ last;
        }

        location /websockify/ {
            access_by_lua_block {

                local secret_token = os.getenv("SECRET_TOKEN")
                if not secret_token then
                    ngx.status = ngx.HTTP_FORBIDDEN
                    ngx.say("403 Forbidden: Server misconfiguration - SECRET_TOKEN is not set.")
                    return ngx.exit(ngx.HTTP_FORBIDDEN)
                end

                local session_cookie = ngx.var.cookie_auth_session
                if session_cookie and session_cookie == secret_token then
                    return
                end

                if string.lower(ngx.var.http_upgrade or "") ~= "websocket" then
                    local uri = ngx.var.uri or "/websockify/"
                    ngx.log(ngx.WARN, "URI: ", uri)

                    if uri == "/websockify/" then
                        return
                    end

                    local pattern = [[^/websockify/[^/]+\.(html|css|js|map|png|svg|ico|json|woff|woff2)$]]
                    if ngx.re.match(uri, pattern) then
                        ngx.log(ngx.WARN, "Matched as static resource, allowing access to: ", uri)
                        return
                    end

                    ngx.log(ngx.WARN, "Blocked unauthorized HTTP access to: ", uri or "nil")
                    ngx.status = ngx.HTTP_FORBIDDEN
                    ngx.say("403 Forbidden: Access to this endpoint is not allowed.")
                    return ngx.exit(ngx.HTTP_FORBIDDEN)
                end

                local args = ngx.req.get_uri_args()
                local password = args.password

                if password and password == secret_token then
                    local secure_flag = ""
                    if ngx.var.https == "on" then
                        secure_flag = "; Secure"
                    end
                    ngx.header["Set-Cookie"] = "auth_session=" .. password .. "; Path=/websockify/; HttpOnly; SameSite=Strict" .. secure_flag
                    return
                end

                ngx.status = ngx.HTTP_FORBIDDEN
                ngx.say("403 Forbidden: Invalid or missing credentials.")
                return ngx.exit(ngx.HTTP_FORBIDDEN)
            }

            proxy_pass http://127.0.0.1:8000/;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        location / {
            return 404;
        }
    }
}
